(function() {
  'use strict';
  
  const CONFIG = {
    api: 'https://raw.githubusercontent.com/dhan-singh-developer/cdn-assets-v2/main/db.json',
    fallback: 'https://api.github.com/repos/dhan-singh-developer/cdn-assets-v2/contents/db.json',
    cache: '_ngp_lic_v1',
    interval: 86400000,
    checkDelay: 2000
  };
  
  function log(msg, type = 'info') {
    if (window.location.hostname === 'localhost') {
      console.log(`[NGP License] ${msg}`);
    }
  }
  
  async function fetchLicenseData() {
    try {
      log('Fetching license data...');
      const response = await fetch(CONFIG.api + '?t=' + Date.now(), {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache'
        }
      });
      
      if (!response.ok) {
        log('Primary API failed, trying fallback...', 'warn');
        const fallbackResponse = await fetch(CONFIG.fallback);
        if (fallbackResponse.ok) {
          const data = await fallbackResponse.json();
          const content = atob(data.content);
          return JSON.parse(content);
        }
        throw new Error('All APIs failed');
      }
      
      const data = await response.json();
      log('License data fetched successfully');
      return data;
    } catch (error) {
      log('Fetch error: ' + error.message, 'error');
      return null;
    }
  }
  
  function getCurrentHost() {
    let host = window.location.hostname.toLowerCase();
    host = host.replace(/^www\./, '');
    return host;
  }
  
  function verifyLicense(licenseData) {
    if (!licenseData || !licenseData.d) {
      log('Invalid license data structure', 'error');
      return { valid: false, reason: 'no_data' };
    }
    
    const currentHost = getCurrentHost();
    const encodedHost = btoa(currentHost);
    
    log(`Current host: ${currentHost}`);
    log(`Encoded: ${encodedHost}`);
    
    // Check blocked sites
    if (licenseData.b && Array.isArray(licenseData.b)) {
      if (licenseData.b.includes(encodedHost)) {
        log('Site is in blocklist!', 'error');
        return { valid: false, reason: 'blocked' };
      }
    }
    
    // Find license
    const license = licenseData.d.find(lic => {
      if (!lic.h) return false;
      return lic.h === encodedHost;
    });
    
    if (!license) {
      log('No license found for this domain', 'warn');
      log('Available licenses: ' + licenseData.d.length);
      return { valid: false, reason: 'not_found' };
    }
    
    log(`License found: ${license.i}`);
    
    // Check status
    if (license.s !== 1) {
      log('License is inactive', 'error');
      return { valid: false, reason: 'inactive' };
    }
    
    // Check expiry (only for non-lifetime)
    if (license.t !== 'l') {
      const now = Date.now();
      if (license.e < now) {
        log('License expired', 'error');
        return { valid: false, reason: 'expired', license: license };
      }
    }
    
    log('License verification successful!');
    return { valid: true, license: license };
  }
  
  function getCachedData() {
    try {
      const cached = localStorage.getItem(CONFIG.cache);
      if (!cached) return null;
      
      const data = JSON.parse(atob(cached));
      if (!data.timestamp) return null;
      
      // Check if cache is still valid (24 hours)
      if (Date.now() - data.timestamp > CONFIG.interval) {
        log('Cache expired');
        return null;
      }
      
      log('Using cached license data');
      return data.license;
    } catch (e) {
      return null;
    }
  }
  
  function cacheData(license) {
    try {
      const data = {
        license: license,
        timestamp: Date.now()
      };
      localStorage.setItem(CONFIG.cache, btoa(JSON.stringify(data)));
      log('License cached successfully');
    } catch (e) {
      log('Cache save failed', 'warn');
    }
  }
  
  function blockSite(reason, message) {
    log(`Blocking site: ${reason}`, 'error');
    
    // Stop execution
    if (window.stop) window.stop();
    
    // Clear page
    document.documentElement.innerHTML = '';
    
    // Create block screen
    const blockDiv = document.createElement('div');
    blockDiv.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    `;
    
    let emoji = '‚ö†Ô∏è';
    let title = 'Verification Failed';
    let actionBtn = '';
    
    if (reason === 'expired') {
      emoji = '‚è∞';
      title = 'License Expired';
      message = 'Your license has expired. Please renew to continue.';
      actionBtn = '<a href="https://nexgenplugins.com/renew" style="display:inline-block;margin-top:20px;padding:12px 30px;background:#fff;color:#667eea;text-decoration:none;border-radius:25px;font-weight:600;box-shadow:0 4px 15px rgba(0,0,0,0.2);">Renew License</a>';
    } else if (reason === 'blocked') {
      emoji = 'üö´';
      title = 'Site Blocked';
      message = 'This site has been blocked due to license violation.';
      actionBtn = '<a href="https://nexgenplugins.com/support" style="display:inline-block;margin-top:20px;padding:12px 30px;background:#fff;color:#667eea;text-decoration:none;border-radius:25px;font-weight:600;box-shadow:0 4px 15px rgba(0,0,0,0.2);">Contact Support</a>';
    } else if (reason === 'not_found') {
      emoji = '‚ùå';
      title = 'No Valid License';
      message = 'No valid license found for this domain. Please contact support.';
      actionBtn = '<a href="https://nexgenplugins.com/purchase" style="display:inline-block;margin-top:20px;padding:12px 30px;background:#fff;color:#667eea;text-decoration:none;border-radius:25px;font-weight:600;box-shadow:0 4px 15px rgba(0,0,0,0.2);">Get License</a>';
    } else {
      message = 'License verification failed. Please contact support.';
      actionBtn = '<a href="https://nexgenplugins.com/support" style="display:inline-block;margin-top:20px;padding:12px 30px;background:#fff;color:#667eea;text-decoration:none;border-radius:25px;font-weight:600;box-shadow:0 4px 15px rgba(0,0,0,0.2);">Contact Support</a>';
    }
    
    blockDiv.innerHTML = `
      <div style="text-align:center;color:#fff;max-width:500px;padding:40px;">
        <div style="font-size:80px;margin-bottom:20px;">${emoji}</div>
        <h1 style="font-size:32px;margin:0 0 15px 0;font-weight:700;">${title}</h1>
        <p style="font-size:16px;margin:0 0 10px 0;opacity:0.95;line-height:1.6;">${message}</p>
        <p style="font-size:14px;margin:0;opacity:0.85;">Domain: <strong>${getCurrentHost()}</strong></p>
        ${actionBtn}
        <p style="font-size:12px;margin-top:30px;opacity:0.7;">
          Powered by <a href="https://nexgenplugins.com" style="color:#fff;text-decoration:underline;">NexGenPlugins</a>
        </p>
      </div>
    `;
    
    document.documentElement.appendChild(blockDiv);
    
    // Prevent interactions
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
  }
  
  function injectFooterCredit(license) {
    // Check if credit removal is allowed
    if (license && license.m && license.m.c === 1) {
      log('Credit removal allowed for this license');
      return;
    }
    
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        const footer = document.querySelector('footer') || 
                      document.querySelector('.footer') || 
                      document.querySelector('#footer') ||
                      document.querySelector('[class*="footer"]') ||
                      document.querySelector('[id*="footer"]');
        
        if (footer) {
          const existingCredit = footer.querySelector('a[href*="nexgenplugins"]');
          
          if (!existingCredit) {
            const creditDiv = document.createElement('div');
            creditDiv.style.cssText = 'text-align:center;padding:10px;font-size:13px;color:#666;border-top:1px solid #e0e0e0;margin-top:15px;';
            creditDiv.innerHTML = 'Template by <a href="https://nexgenplugins.com/" rel="dofollow" style="color:#0b57d0;font-weight:600;text-decoration:none;" target="_blank">NexGenPlugins</a>';
            footer.appendChild(creditDiv);
            log('Footer credit injected');
          }
        } else {
          log('No footer element found', 'warn');
        }
      }, 1000);
    });
  }
  
  async function init() {
    log('Initializing license system...');
    
    try {
      // Check cache first
      const cachedLicense = getCachedData();
      if (cachedLicense) {
        injectFooterCredit(cachedLicense);
        return;
      }
      
      // Fetch fresh data
      const licenseData = await fetchLicenseData();
      
      if (!licenseData) {
        log('Failed to fetch license data. Using grace period.', 'warn');
        // Grace period - don't block if network failed
        return;
      }
      
      // Verify license
      const verification = verifyLicense(licenseData);
      
      if (!verification.valid) {
        blockSite(verification.reason, 'License verification failed');
        return;
      }
      
      // Cache valid license
      cacheData(verification.license);
      
      // Inject credit if needed
      injectFooterCredit(verification.license);
      
      log('License system initialized successfully');
      
    } catch (error) {
      log('Init error: ' + error.message, 'error');
      // Don't block on error - grace period
    }
  }
  
  // Initialize with delay
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(init, CONFIG.checkDelay);
    });
  } else {
    setTimeout(init, CONFIG.checkDelay);
  }
  
  // Periodic check (every 24 hours)
  setInterval(init, CONFIG.interval);
  
})();
